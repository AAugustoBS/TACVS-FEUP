/**
 * {{ screen.name }} Page
 */

import { ComponentRegistry } from '../components.js';
import { ItemApi } from '../api.js';

export class {{ screen.name | camel_case }}Page {
    constructor(params = {}) {
        this.params = params;
        this.components = new ComponentRegistry();
        this.data = {};
    }

    isLoggedIn() {
        return localStorage.getItem("isLoggedIn") === "true";
    }

    async fetchData() {
        {% if screen.name == 'ItemListScreen' %}
        this.data.items = await ItemApi.getAll();
        {% elif screen.name == 'ItemDetailsScreen' %}
        if (!this.params.id) return;
        this.data.item = await ItemApi.getById(this.params.id);
        {% endif %}
    }

    async render() {
        // ---------- AUTH GUARD ----------
        {% if screen.name in ['PaymentScreen', 'CheckoutScreen'] %} 
        if (!this.isLoggedIn()) {
            if (window.location.hash.toLowerCase() !== '#/loginscreen') {
                window.location.hash = '#/loginscreen';
            }
            return '';
        }
        {% endif %}

        // ---------- ITEM DETAILS GUARD ----------
        {% if screen.name == 'ItemDetailsScreen' %}
        if (!this.params.id) {
            if (window.location.hash.toLowerCase() !== '#/itemlistscreen') {
                window.location.hash = '#/itemlistscreen';
            }
            return '';
        }
        {% endif %}

        await this.fetchData();

        {% if screen.name == 'ItemListScreen' %}
        return `
            <h1>Items</h1>
            <div class="list-items">
                ${this.data.items.map(item => `
                    <div class="item-card">
                        <h3>${item.title}</h3>
                        <p>${item.price} €</p>
                        <a href="#/itemdetailsscreen?id=${item.id}">
                            View details
                        </a>
                    </div>
                `).join('')}
            </div>
        `;
        {% elif screen.name == 'ItemDetailsScreen' %}
        if (!this.data.item) {
            if (window.location.hash.toLowerCase() !== '#/itemlistscreen') {
                window.location.hash = '#/itemlistscreen';
            }
            return '';
        }

        return `
            <h1>${this.data.item.title}</h1>
            <p>${this.data.item.description}</p>
            <p>Price: ${this.data.item.price} €</p>
            <a href="#/itemlistscreen">Back to list</a>
        `;
        {% else %}
        return `
            <h1>{{ screen.name }}</h1>
        `;
        {% endif %}
    }

    init() {}
}
