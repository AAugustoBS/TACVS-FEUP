/**
 * Router - Single Page Application Router
 * Handles client-side routing for {{ gui.name }}
 */

{% for module in gui.modules %}
{% for screen in module.screens %}
import { {{ screen.name | camel_case }}Page } from './pages/{{ screen.name | lower }}.js';
{% endfor %}
{% endfor %}

export class Router {
    constructor() {
        this.routes = [];
        this.currentRoute = null;
        this.setupRoutes();
    }

    setupRoutes() {
        this.routes = [
            {% for module in gui.modules %}
            {% for screen in module.screens %}
            {
                path: '/{{ screen.name | lower }}',
                name: '{{ screen.name }}',
                title: '{{ screen.name }}',
                handler: {{ screen.name | camel_case }}Page,
                params: {},
                isMain: {{ 'true' if screen.is_main_page else 'false' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
            {% endfor %}
        ];
    }

    init() {
        window.addEventListener('hashchange', () => this.handleRoute());
        this.handleRoute();
    }

    async handleRoute() {
        let hash = window.location.hash.substring(1).toLowerCase();

        if (!hash || hash === '/') {
            const mainRoute = this.routes.find(r => r.isMain);
            const fallbackRoute = this.routes[0];
            const target = mainRoute || fallbackRoute;
            if (target) {
                window.location.hash = target.path;
                return;
            }
        }

        const route = this.matchRoute(hash);

        if (route) {
            await this.loadRoute(route, hash);
        } else {
            this.show404();
        }
    }

    matchRoute(url) {
        const [path, queryString] = url.split('?');
        const cleanPath = path.replace(/^\/+|\/+$/g, ''); // remove leading/trailing slashes

        for (const route of this.routes) {
            const routePath = route.path.substring(1).toLowerCase();
            const params = this.extractParams(routePath, cleanPath);
            if (params !== null) {
                if (queryString) {
                    const qs = new URLSearchParams(queryString);
                    for (const [k, v] of qs.entries()) {
                        params[k] = v;
                    }
                }
                return { ...route, params };
            }
        }
        return null;
    }

    extractParams(pattern, url) {
        const patternParts = pattern.split('/');
        const urlParts = url.split('/');

        if (patternParts.length !== urlParts.length) return null;

        const params = {};
        for (let i = 0; i < patternParts.length; i++) {
            if (patternParts[i].startsWith(':')) {
                const paramName = patternParts[i].substring(1);
                params[paramName] = urlParts[i];
            } else if (patternParts[i] !== urlParts[i]) {
                return null;
            }
        }
        return params;
    }

    async loadRoute(route, url) {
        try {
            document.title = '{{ gui.name }} - ' + route.title;

            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            mainContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            `;

            const pageInstance = new route.handler(route.params);
            const content = await pageInstance.render();

            mainContent.classList.add('page-exit');

            setTimeout(() => {
                mainContent.innerHTML = content;
                mainContent.classList.remove('page-exit');
                mainContent.classList.add('page-enter');

                pageInstance.init();

                setTimeout(() => {
                    mainContent.classList.remove('page-enter');
                }, 300);
            }, 150);

            this.currentRoute = route;

        } catch (error) {
            console.error('Error loading route:', error);
            this.showError('Failed to load page');
        }
    }

    navigate(path) {
        window.location.hash = path.toLowerCase();
    }

    back() {
        window.history.back();
    }

    show404() {
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h2 class="empty-state-title">Page Not Found</h2>
                    <p class="empty-state-description">
                        The page you're looking for doesn't exist.
                    </p>
                    <button class="action-button action-button-primary" onclick="window.location.hash='/'">
                        Go Home
                    </button>
                </div>
            `;
        }
    }

    showError(message) {
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="error">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="action-button action-button-primary" onclick="location.reload()">
                        Reload Page
                    </button>
                </div>
            `;
        }
    }
}
